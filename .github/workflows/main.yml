name: Main
on:
  push:
    branches:
    - master
  pull_request:
    branches:
    - master
    types:
    - closed
jobs:
  build:
    name: Build
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        java-version: [11.0.3]
        operating-system: [ubuntu-latest]
    steps:
    - name: Prepare
      uses: actions/checkout@v2
    - name: Set Up Java Development Kit
      uses: actions/setup-java@v2
      with:
        java-version: ${{ matrix.java-version }}
        distribution: adopt
        cache: maven
        server-id: github
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
    - name: Maven clean test package
      run: |
        mvn clean
        mvn test
        mvn package --file pom.xml
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
    - name: Archive artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build
        path: build
        retention-days: 1
  deploy:
    name: Deploy
    needs: build
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        java-version: [11.0.3]
        operating-system: [ubuntu-latest]
    steps:
    - name: Check out the repo
      uses: actions/checkout@v2
    - name: Download artifacts
      uses: actions/download-artifact@v2
      with:
        name: build
        path: build
    - name: Set Up Java Development Kit
      uses: actions/setup-java@v2
      with:
        java-version: ${{ matrix.java-version }}
        distribution: adopt
        cache: maven
        server-id: github
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
        gpg-passphrase: MAVEN_GPG_PASSPHRASE
    - name: Configure Git user
      run: |
        git config user.email "actions@github.com"
        git config user.name "GitHub Actions"
    - name: Maven Release
      run: mvn -B release:prepare release:perform
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}